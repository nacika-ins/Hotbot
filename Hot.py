#!/home/nacika/.virtualenvs/akicansoft/bin/python
# -*- coding: utf-8 -*-
#ver. 0.9 β
import google
import time
import logging
import re

#デバッグするかどうか
DEBUG = False

def main():

    #Googleにログイン
    #print "ログインしています"
    g = google.Login("", "")
    if not DEBUG:
        #Release
        plus = g.plus("104276121103951618860")
    else:
        #Debug
        plus = g.plus("107783647697859888499")
    
    post = plus.post()
    
    #除外する正規表現
    ngreg = re.compile(r"(ぐっもーにん|ぐっも～にん|オハヨウ|good morning|Good mornwing|G\+モーニング|お早う|おはよう|おはです|おっは[ー〜]|オハヨー|おは(ＹＯ|YO)|あっはよお|おはよ|[起お]きた|おはお|おっはよ|おー?はー?よー?ん|おはろ|はろはろ|おーはー|目が覚めた|めがさめた|おはほむ|おはいお|おっはよう|おっはー|おやすみなさい|おやす|[寝ね]ます|寝|ｵﾔ.*ｽﾐ|zzz|ねまー|[ね寝]る|[ね寝]っるよ|オヤスミ|お休み|おやすみ|おっやすみ|お早う)")

    #AKB,SKE,NMBのユーザーIDデータを読み込む
    #print "AKBSKEのデータを読み込んでいます"

    akbskenmblist = [
                     "108367535733172853340", "111700319553120354024", "105229500895781124316", "105312608513060875034", "103259286719163415846", "117480374878682152542", "112309691086068535265", "101026469701528255144", "102844391735210836268", "116582420246242769167", "113474433041552257864", "109273326082502819549", "117151902078571783647", "115842256718368316968", "106541618903520668641", "104375100134443203420", "106902079329146402543", "103787924613525409143", "102181587900817571440", "107954758685270685108", "113175170244847276511", "111171583195412578810", "105020230123170728064", "110841113220926588945", "109547251260290757268", "109380179669644031316", "108623251197634437138", "111186383073996701022", "108485060451296256117", "110230842586402039931", "115449512138863581856", "116563387779051485156", "110106903212386059477", "102249965218267255722", "106281038518216462788", "114739367195523292316", "112077362806147944184", "106819068054122298292", "108406705498777962659", "105599945949824406376", "114392080665434978357", "102861211420357915358", "116816132092699657436", "101031357714890657558",
                     "111050677534976069347", "100593468647281401358", "108705263081706477178", "111792731544936626652", "118425778047788093453", "115975634910643785199", "102565671074822095382", "102764447672444416615", "111254737005235237589", "114397630658650917209", "108037953963364967101", "100806834975375116663", "100200160956657706975", "116324240483798147615", "103904242672756284899", "106656898590733509216", "108340808318911923001", "101713591556895969107", "106926723626971174827", "113499890803474188597", "108536765591006886419", "112166094088653039891", "107135851528812577523", "107061289389523750061", "102982862918484502371", "112980138521977900424", "111145641865855965824", "111253632744203791499",
                     "109544372058574620997", "106758056094193397775", "101064661667017020038", "110216234612751595989", "106176150979443047095", "101423472932208115437", "111799140715858863784", "105842454176256413407", "101854092637878212405", "102277090985412703374", "117533056464814306425", "117147321771860727748", "112063625278289697769", "100757137373116382078", "117655629637021320261", "103663030781390958288", "114488817218493827050", "103388469578205010447", "100269342405848026537", "116751037770394303220", "115719063745850111024", "104432502432473755826", "108897254135232129896", "100694839033896673847", "109052751022632539844", "111886243683596094429", "111118114050350393642", "114693866568676269449",
                     "107690626854317593303", "108246279762026812099", "101763044621259372363", "115154079096419739247", "109052751022632539844", "117847838306056282869", "115743581016964883134", "105835152133357364264", "101748015513264110691", "104832409151547328144", "101238058961311557814", "101637952441360556747", "104469157599705660710", "111886243683596094429", "113029702385411102951", "101666520014328843283", "107910364578005352567", "100694627368957691223", "107953103521320651388", "111810846135180115151", "102663035987142737445", "114038303885145553998", "100063943132747828422", "109793323492513330070", "106346370911183711893", "115940285904755808895", "107000363532428575751", "112984877710421269938", "102440721186115061522", "100987694249056428673", "104794906427493486303", "107690626854317593303", "111438309227794971277", "108246279762026812099", "101763044621259372363",
                     "118370370953021367600", "104529234818538128511", "110515811233847190239", "110515811233847190239", "104563810664419686877", "113548903943701827498", "100515188323145163173", "104540799121659392739", "111183489254439809555", "103948509378248185139", "108841554434587390767", "117433562651585228733", "109310472381413281309", "117896186544129616545", "101584503735010828799", "116080183063480282368", "104137648731435726318", "102372344957102189329", "111001986183198441065", "116080183063480282368", "115313835371482911514", "116852193162190904300", "107241677527739013868", "107674992218008076992", "116080183063480282368", "104341148263550771546", "117429983367030282830", "117516762830406649713", "105015705151101532017", "114433951972746099923", "114433951972746099923", "111726993387349262398", "101092011169016421448", "110547918216387313519", "109057690948151627836", "111363964900769496942", "107456237173689373341", "115608229387461419797", "116252784914637564000", "106102390858541443310", "113516536547276113860", "117122356051025200492",
                     "111886243683596094429", "101584503735010828799", "108592604171173727989", "110228651304968689682", "108734175672740889367", "110018085870094502593", "110525631600509252689", "111183489254439809555", "101637952441360556747", "110515811233847190239", "109140442575159610384", "107858117023519021548", "101238058961311557814", "104185663412698594190", "114433951972746099923", "115608229387461419797", "100987694249056428673", "117122356051025200492", "102808008463301583196", "108841554434587390767", "104424976615287976283", "117214005905987253541", "109310472381413281309", "107241677527739013868", "102372344957102189329", "113029702385411102951", "118370370953021367600", "100063943132747828422", "109052751022632539844", "102663035987142737445", "101092011169016421448", "105328900551339818980", "116999436633946440277", "105975378768005691666", "101666520014328843283", "107953103521320651388", "110217243079976772788", "105015705151101532017", "106837344952867534542", "102839473765308016371", "103713218956069883516", "115940285904755808895", "100515188323145163173", "102440721186115061522", "107910364578005352567", "104794906427493486303", "117847838306056282869", "104137648731435726318", "113516536547276113860", "109638186060118072119",
                     "103948509378248185139", "111363964900769496942", "109793323492513330070", "107456237173689373341", "104846917278979290942", "105835152133357364264", "115313835371482911514", "111810846135180115151", "114693866568676269449", "104341148263550771546", "108121336346623963998", "111118114050350393642", "117429983367030282830", "107000363532428575751", "111438309227794971277", "105739481850011872539", "111907069956262615426", "117896186544129616545", "100694839033896673847", "115154079096419739247", "108341666924993077629", "112809008708989184267", "118292013193988155683", "110219169108613831999", "111726993387349262398", "107756318055823246187", "111001986183198441065", "113548903943701827498", "106346370911183711893", "117433562651585228733", "116852193162190904300", "112984877710421269938", "107674992218008076992", "104529234818538128511", "116080183063480282368", "102859549141435220113", "104832409151547328144", "104540799121659392739", "115743581016964883134", "116819083606243987960", "111167834152662625124", "114117235562724035328", "117516762830406649713", "107850647144188324652", "104469157599705660710", "114038303885145553998", "101748015513264110691", "102120909316124491120", "115730192449019105814", "101763044621259372363", "110547918216387313519", "108246279762026812099",
                     "115765743928146295934", "116252784914637564000", "101027924315502812552", "100694627368957691223", "109229124597499008502", "106102390858541443310", "109057690948151627836", "110780930132548888998", "117147321771860727748", "116751037770394303220", "104432502432473755826", "102988890725022311407", "106758056094193397775", "101064661667017020038", "112063625278289697769", "111799140715858863784", "113474433041552257864", "105020230123170728064", "102764447672444416615", "101026469701528255144", "108406705498777962659",
                     "106656898590733509216", "105842454176256413407", "112077362806147944184", "118425778047788093453", "105229500895781124316", "110216234612751595989", "108367535733172853340", "116324240483798147615", "107135851528812577523", "111145641865855965824", "110230842586402039931", "109547251260290757268", "108485060451296256117", "108340808318911923001", "102861211420357915358", "114392080665434978357", "102982862918484502371", "117533056464814306425", "103787924613525409143", "100200160956657706975", "114739367195523292316", "103904242672756284899", "111171583195412578810", "104375100134443203420", "108623251197634437138", "112309691086068535265", "112980138521977900424", "102181587900817571440", "114397630658650917209", "105312608513060875034", "113499890803474188597", "102844391735210836268", "106176150979443047095", "109273326082502819549", "115975634910643785199", "100806834975375116663", "107954758685270685108", "112166094088653039891", "114488817218493827050", "116816132092699657436", "106926723626971174827", "111253632744203791499", "115449512138863581856", "103259286719163415846", "101713591556895969107", "102249965218267255722", "106819068054122298292", "106902079329146402543", "107061289389523750061", "115842256718368316968", "100757137373116382078", "117151902078571783647", "106541618903520668641",
                     "101031357714890657558", "108037953963364967101", "117480374878682152542", "100593468647281401358", "111254737005235237589", "101854092637878212405", "111050677534976069347", "116582420246242769167", "116563387779051485156", "111700319553120354024", "108536765591006886419", "110106903212386059477", "108705263081706477178", "111792731544936626652", "113175170244847276511", "105599945949824406376", "111186383073996701022", "117655629637021320261", "102565671074822095382", "103663030781390958288", "102277090985412703374", "101423472932208115437", "109380179669644031316", "110841113220926588945", "109544372058574620997"
                     ]

    
    
    
    
    #ログリストの生成
    #print "ログリストを生成しています"
    loglist = []
    if 1:
        act = plus.activity("", 40)
        
        for i in range(act.length()):
            postid = act.resharepostid(i)
            if postid:
                loglist.append(postid)
        time.sleep(10)
            
    #print "loglist: "
    #print loglist
    #print "ループに入ります"
    while(1):

        if not DEBUG:
            #10分待つ
            #print "60分待機中"
            time.sleep(60 * 60)
        
        #人気の投稿を取得
        #print "人気の投稿を取得しています"
        hot = plus.hot(40)

        #投稿の文だけ繰り返す
        while(1):
            
            #ポスト数を取得
            postlen = hot.length()
            
            #取得できるポストが0になったら抜ける
            if postlen == 0:
                break
            
            #ポストの取得
            for i in range(postlen):
                
                #AKBが含まれているか調べる
                postuserid = hot.postuserid(i)
                flag = 0
                for ii in akbskenmblist:
                    if ii == postuserid:
                        flag = 1
                        break
                if flag:
                    #print "AKBの投稿です: "+hot.permalink(i)
                    continue
                
                #NG正規表現が含まれている場合
                try:
                    if ngreg.search(hot.postbody(i)).group(1):
                        #print "NGワードが含まれていました: "+hot.permalink(i)
                        continue
                except:
                    pass
    
                #すでに投稿したものだった場合無視
                postid = hot.postid(i)
                flag = 0
                for ii in loglist:
                    if ii == postid:
                        flag = 1
                        break
                if flag == 1:
                    #print "すでに投稿されたものです: "+hot.permalink(i)
                    continue
    
                #含まれていない場合実行
                #print "ユーザー名: "+hot.postusername(i)
                #print "ユーザーID: "+postuserid
                #print "本文: "+hot.postbody(i)
                #print "コメント数: "+str(hot.commentlength(i))
                #print "再共有数: "+str(hot.sharelength(i))
                #print "+1数: "+str(hot.plusonelength(i))
                #print "ポストID: "+postid
                #print "----------------------------------------"
                
                #投稿
                post.reshare(hot.permalink(i), postid)
                #print "投稿しました: "+hot.permalink(i)
                time.sleep(10)
                
                #ログに追加する
                loglist.append(postid)
                
                #ログの肥大化を防止
                if len(loglist) >= 1000:
                    loglist = loglist[1:]
            
            #次のノードを取得
            time.sleep(10)
            hot = hot.nextactivity()
        
        if DEBUG:
            #10分待つ
            #print "10分待機中"
            time.sleep(60 * 10)

if __name__ == '__main__':
    #エラーのときは再起動する
    if DEBUG:
        main()
    else:
        while(1):
            try:
                main()
            except Exception, _error:
                logging.error(str(_error))
                print "Error: " + str(_error)
                #print "エラーが発生しました"
                #print "10分待機中"
                time.sleep(60 * 10)
                continue
        
